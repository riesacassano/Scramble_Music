---
title: "E3 alignment"
author: "R. Cassano-Coleman"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
knit: (function(inputFile, encoding) {rmarkdown::render(inputFile, encoding = encoding, output_dir = "notebooks") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # version 2.0.0
library(magrittr) # version 2.0.3
library(rstatix) # version 0.7.2

library(brms) # version 2.22.0
library(bayestestR) # version 0.15.0
library(emmeans) # version 1.10.0
```

This notebook analyzes alignment values using a Bayesian approach.

```{r}
set.seed(15000)
```

Load the data.
```{r}
data <- read_csv('../data/E3/alignment.csv', show_col_types = FALSE)
```

Check number of subjects per group.

```{r}
length(unique(filter(data, Musician == 'Yes')$sub))
length(unique(filter(data, Musician == 'No')$sub))
```


Make sure non-musicians and musicians are labelled with different numbers.
```{r}
data %<>% mutate(sub = ifelse(Musician == 'Yes', sub, sub + 49))
```

Pivot the data longer.
```{r}
data %<>% pivot_longer(cols = -c(Musician, sub, scramble), 
                       names_to = 'level', values_to = 'value')
```



For comparisons across levels, look at nested structure only (levels 2, 4, 8, 16).
```{r}
data_nested <- data %>%
  filter(!level %in% c(1,3,5))
```

Make group, scramble, and level into factors and set contrasts.
```{r}
data %<>% mutate(
  Musician = factor(Musician, levels = c('Yes', 'No')),
  scramble = factor(scramble, levels = c('Intact', '8B', '2B', '1B')),
  level = factor(level, levels = c(1,2,3,4,5,8,16), ordered = TRUE)
  )

contrasts(data$scramble) <- contr.treatment(4) # Intact as reference
contrasts(data$level) <- contr.treatment(7, base = 6) # 8-bar as reference
contrasts(data$Musician) <- c(-1,1)
```

```{r}
data_nested %<>% mutate(
  Musician = factor(Musician, levels = c('Yes', 'No')),
  scramble = factor(scramble, levels = c('Intact', '8B', '2B', '1B')),
  level = factor(level, levels = c(2,4,8,16), ordered = TRUE)
  )

contrasts(data_nested$scramble) <- contr.treatment(4) # Intact as reference
contrasts(data_nested$level) <- contr.treatment(4, base = 3) # 8-bar as reference
contrasts(data_nested$Musician) <- c(-1,1)
```

Check normality of the data.
```{r}
data %>% 
  group_by(scramble, level) %>%
  shapiro_test(value)
```

Visualize.
```{r}
data %>%
  ggplot(aes(x = level, y = value)) +
  geom_jitter(width = 0.25, alpha = 0.25) +
  facet_wrap(vars(scramble)) +
  ylim(-0.25, 0.5)
```

\newpage

# Main analysis

```{r, include=FALSE}
get_prior(value ~ Musician + scramble + level + (1|sub), data = data_nested)
```

```{r, include=FALSE}
# not run - this block is for reference
# group contrast - expect Musicians to be more aligned
#set_prior('normal(-0.1, 0.1)', coef = 'Musician1')

# Intact to 8B contrast - expect greater alignment in 8B since phrase level is emphasized by scramble
#set_prior('normal(0.1, 0.1)', coef = 'scramble2')

# Intact to 2B and 1B contrast - expect greater alignment in Intact since structure is disrupted in 2B and 1B
#set_prior('normal(-0.1, 0.1)', coef = 'scramble3')
#set_prior('normal(-0.1, 0.1)', coef = 'scramble4')

# 8-bar to all other levels - expect 8-bar to be preferred
# nested
#set_prior('normal(-0.2, 0.1)', coef = 'level1')
#set_prior('normal(-0.1, 0.1)', coef = c('level2', 'level4')) # 4 and 16 less bad
# all levels
#set_prior('normal(-0.2, 0.1)', coef = c('level1', 'level2', 'level3', 'level5'))
#set_prior('normal(-0.1, 0.1)', coef = c('level4', 'level7')) # 4 and 16 less bad

# interactions
#set_prior('normal(0, 0.1)', coef = c()) # fill in here...
```

```{r}
nested_3way <- brm(value ~ Musician + scramble + level + (1|sub), data = data_nested,
                   prior = c(
                     set_prior('normal(-0.1, 0.1)', coef = 'Musician1'),
                     set_prior('normal(0.1, 0.1)', coef = 'scramble2'),
                     set_prior('normal(-0.1, 0.1)', coef = 'scramble3'),
                     set_prior('normal(-0.1, 0.1)', coef = 'scramble4'),
                     set_prior('normal(-0.2, 0.1)', coef = 'level1'),
                     set_prior('normal(-0.1, 0.1)', coef = c('level2', 'level4')) 
                   ),
                   save_pars = save_pars(all = TRUE), iter = 20000, refresh = 0,
                   file = 'models/E3_alignment_3way_noInt')
```

```{r}
plot(nested_3way)
```

```{r}
print(summary(nested_3way, robust = TRUE), digits = 4)
```


\newpage

```{r}
nested_noMus <- brm(value ~ scramble + level + (1|sub), data = data_nested,
                    prior = c(
                     set_prior('normal(0.1, 0.1)', coef = 'scramble2'),
                     set_prior('normal(-0.1, 0.1)', coef = 'scramble3'),
                     set_prior('normal(-0.1, 0.1)', coef = 'scramble4'),
                     set_prior('normal(-0.2, 0.1)', coef = 'level1'),
                     set_prior('normal(-0.1, 0.1)', coef = c('level2', 'level4')) 
                   ),
                   save_pars = save_pars(all = TRUE), iter = 20000, refresh = 0,
                   file = 'models/E3_alignment_2way_noMus')

nested_noScram <- brm(value ~ Musician + level + (1|sub), data = data_nested,
                      prior = c(
                     set_prior('normal(-0.1, 0.1)', coef = 'Musician1'),
                     set_prior('normal(-0.2, 0.1)', coef = 'level1'),
                     set_prior('normal(-0.1, 0.1)', coef = c('level2', 'level4')) 
                   ),
                   save_pars = save_pars(all = TRUE), iter = 20000, refresh = 0,
                   file = 'models/E3_alignment_2way_noScram')

nested_noLevel <- brm(value ~ Musician + scramble + (1|sub), data = data_nested,
                      prior = c(
                     set_prior('normal(-0.1, 0.1)', coef = 'Musician1'),
                     set_prior('normal(0.1, 0.1)', coef = 'scramble2'),
                     set_prior('normal(-0.1, 0.1)', coef = 'scramble3'),
                     set_prior('normal(-0.1, 0.1)', coef = 'scramble4')
                   ),
                   save_pars = save_pars(all = TRUE), iter = 20000, refresh = 0,
                   file = 'models/E3_alignment_2way_noLevel')
```

\newpage

Model without group:

```{r}
plot(nested_noMus)
print(summary(nested_noMus, robust = TRUE), digits = 4)
```


\newpage

Model without condition:

```{r}
plot(nested_noScram)
print(summary(nested_noScram, robust = TRUE), digits = 4)
```

\newpage

Model without level: 

```{r}
plot(nested_noLevel)
print(summary(nested_noLevel, robust = TRUE), digits = 4)
```



\newpage

## Main effect of group
```{r}
BF_nested_mus <- bayes_factor(nested_3way, nested_noMus)
print(BF_nested_mus)
```

Strong evidence against a main effect of group.


## Main effect of condition
```{r}
BF_nested_scram <- bayes_factor(nested_3way, nested_noScram)
print(BF_nested_scram)
```

Very strong evidence for a main effect of condition.

## Main effect of level
```{r}
BF_nested_level <- bayes_factor(nested_3way, nested_noLevel)
print(BF_nested_level)
```

Moderate evidence against a main effect of level.


\newpage

## Interactions

Does adding an interaction between condition and level improve the model? (Without group)

```{r}
nested_justScram <- brm(value ~ scramble + (1|sub), data = data_nested,
                       prior = c(
                         set_prior('normal(0.1, 0.1)', coef = 'scramble2'),
                         set_prior('normal(-0.1, 0.1)', coef = 'scramble3'),
                         set_prior('normal(-0.1, 0.1)', coef = 'scramble4')
                       ),
                       save_pars = save_pars(all = TRUE), 
                       iter = 20000, refresh = 0,
                       file = 'models/E3_alignment_justScram')
```

```{r}
plot(nested_justScram)
print(summary(nested_justScram, robust = TRUE), digits = 4)
```

```{r, include=FALSE}
get_prior(value ~ scramble + scramble:level + (1|sub), data = data_nested)
```

\newpage

```{r}
nested_2way_levelScram <- brm(value ~ scramble + scramble:level + (1|sub), data = data_nested,
                       prior = c(
                         set_prior('normal(0, 0.1)', class = 'b'), # all interactions
                         set_prior('normal(0.1, 0.1)', coef = 'scramble2'),
                         set_prior('normal(-0.1, 0.1)', coef = 'scramble3'),
                         set_prior('normal(-0.1, 0.1)', coef = 'scramble4')
                       ),
                       save_pars = save_pars(all = TRUE), 
                       iter = 20000, refresh = 0,
                       file = 'models/E3_alignment_2way_levelScramInt')
```

```{r}
plot(nested_2way_levelScram)
print(summary(nested_2way_levelScram, robust = TRUE), digits = 4)
```

```{r}
BF_nested_2way_levelScram <- bayes_factor(nested_2way_levelScram, nested_justScram)
print(BF_nested_2way_levelScram)
```

Strong evidence for an interaction between condition and level.


\newpage

Check the other interactions.

```{r}
nested_justLevel <- brm(value ~ level + (1|sub), data = data_nested,
                        prior = c(
                          set_prior('normal(-0.2, 0.1)', coef = 'level1'),
                          set_prior('normal(-0.1, 0.1)', coef = c('level2', 'level4'))
                        ),
                        save_pars = save_pars(all = TRUE), 
                        iter = 20000, refresh = 0,
                        file = 'models/E3_alignment_justLevel')
```

```{r, include=FALSE}
get_prior(value ~ scramble + scramble:Musician + (1|sub), data = data_nested)
```

```{r}
nested_2way_musScram <- brm(value ~ scramble + scramble:Musician + (1|sub), data = data_nested,
                            prior = c(
                              set_prior('normal(0, 0.1)', class = 'b'), # all interactions
                              set_prior('normal(0.1, 0.1)', coef = 'scramble2'),
                              set_prior('normal(-0.1, 0.1)', coef = 'scramble3'),
                              set_prior('normal(-0.1, 0.1)', coef = 'scramble4')
                            ),
                            save_pars = save_pars(all = TRUE), 
                            iter = 20000, refresh = 0,
                            file = 'models/E3_alignment_2way_musScramInt')
nested_2way_musLevel <- brm(value ~ level + level:Musician + (1|sub), data = data_nested,
                            prior = c(
                              set_prior('normal(0, 0.1)', class = 'b'), # all interactions
                              set_prior('normal(-0.2, 0.1)', coef = 'level1'),
                              set_prior('normal(-0.1, 0.1)', coef = c('level2', 'level4'))
                            ),
                            save_pars = save_pars(all = TRUE), 
                            iter = 20000, refresh = 0,
                            file = 'models/E3_alignment_2way_musLevelInt')
```

\newpage

```{r}
plot(nested_justLevel)
print(summary(nested_justLevel, robust = TRUE), digits = 4)
```

\newpage

```{r}
plot(nested_2way_musScram)
print(summary(nested_2way_musScram, robust = TRUE), digits = 4)
```

\newpage

```{r}
plot(nested_2way_musLevel)
print(summary(nested_2way_musLevel, robust = TRUE), digits = 4)
```

\newpage

```{r}
BF_nested_2way_musScram <- bayes_factor(nested_2way_musScram, nested_justScram)
print(formatC(BF_nested_2way_musScram$bf, format = 'e'))
```

```{r}
BF_nested_2way_musLevel <- bayes_factor(nested_2way_musLevel, nested_justLevel)
print(formatC(BF_nested_2way_musLevel$bf, format = 'e'))
```

Very strong evidence against interactions between group and condition and group and level.
